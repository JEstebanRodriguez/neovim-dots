name: Create Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get last release tag
        id: last-release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "Last tag: $LAST_TAG"

      - name: Parse commits and generate release
        id: release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Get repository URL for commit links
          REPO_URL=$(git config --get remote.origin.url | sed 's/.git$//')
          REPO_URL=$(echo "$REPO_URL" | sed 's/git@github.com:/https:\/\/github.com\//')

          # Get commits since last tag
          if [ "$LAST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%h %s")
          else
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%h %s")
          fi

          # Extract version parts
          VERSION=${LAST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Initialize variables
          HAS_BREAKING=false
          HAS_FEATURE=false
          HAS_FIX=false

          BREAKING=""
          FEATURES=""
          PLUGINS_ADDED=""
          PLUGINS_REMOVED=""
          FIXES=""
          CHORES=""

          # Parse each commit
          while IFS= read -r line; do
            if [[ -z "$line" ]]; then
              continue
            fi

            # Extract hash and message
            HASH=$(echo "$line" | awk '{print $1}')
            REST=$(echo "$line" | cut -d' ' -f2-)

            if [[ "$REST" == *"BREAKING"* ]] || [[ "$REST" == *"!"* ]]; then
              HAS_BREAKING=true
              BREAKING+=$(echo "‚Ä¢ ${REST}" | sed 's/.*: //' | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == "feat"* ]]; then
              HAS_FEATURE=true
              if [[ "$REST" == *"plugin"* ]] || [[ "$REST" == *"plugins"* ]]; then
                PLUGINS_ADDED+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
              else
                FEATURES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
              fi
            elif [[ "$REST" == "fix"* ]]; then
              HAS_FIX=true
              FIXES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == *"remove"* ]] && [[ "$REST" == *"plugin"* ]]; then
              PLUGINS_REMOVED+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == "perf"* ]]; then
              FEATURES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == "docs"* ]]; then
              FEATURES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == "refactor"* ]]; then
              FEATURES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            elif [[ "$REST" == "chore"* ]] || [[ "$REST" == "ci"* ]]; then
              CHORES+=$(echo "‚Ä¢ ${REST#*: }" | sed "s#$# ([$HASH]($REPO_URL/commit/$HASH))#")$'\n'
            fi
          done <<< "$COMMITS"

          # Calculate new version
          if [ "$HAS_BREAKING" = true ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$HAS_FEATURE" = true ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$HAS_FIX" = true ]; then
            PATCH=$((PATCH + 1))
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          # Build changelog
          CHANGELOG="v$NEW_VERSION"$'\n\n'

          if [ -n "$BREAKING" ]; then
            CHANGELOG+="Breaking Changes"$'\n'"$BREAKING"$'\n'
          fi

          if [ -n "$PLUGINS_ADDED" ]; then
            CHANGELOG+="New Plugins"$'\n'"$PLUGINS_ADDED"$'\n'
          fi

          if [ -n "$PLUGINS_REMOVED" ]; then
            CHANGELOG+="Removed Plugins"$'\n'"$PLUGINS_REMOVED"$'\n'
          fi

          if [ -n "$FEATURES" ]; then
            CHANGELOG+="Features"$'\n'"$FEATURES"$'\n'
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG+="Bug Fixes"$'\n'"$FIXES"$'\n'
          fi

          if [ -n "$CHORES" ]; then
            CHANGELOG+="Chores"$'\n'"$CHORES"$'\n'
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release Tag
        run: |
          git tag ${{ steps.release.outputs.tag }}
          git push origin ${{ steps.release.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.release.outputs.tag }}
          name: Release ${{ steps.release.outputs.version }}
          body: ${{ steps.release.outputs.body }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Success Message
        run: |
          echo "‚úÖ Release creado exitosamente!"
          echo "üì¶ Version: ${{ steps.release.outputs.version }}"
          echo "üè∑Ô∏è  Tag: ${{ steps.release.outputs.tag }}"
